<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script>
    const imageInput = document.getElementById('image-input');
    const imageContainer = document.getElementById('image-container');
    const convertBtn = document.getElementById('convert-btn');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const downloadBtn = document.getElementById('download-btn');

    let finalPdfBlob = null;  // <-- Store the PDF blob here globally

    imageInput.addEventListener('change', (e) => {
        imageContainer.innerHTML = '';
        const files = e.target.files;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                imageContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    convertBtn.addEventListener('click', async () => {
        const files = imageInput.files;
        if (files.length === 0) {
            alert('Please select images first.');
            return;
        }

        convertBtn.disabled = true;
        convertBtn.textContent = 'Converting...';
        progressBar.style.display = 'block';
        progress.style.width = '0%';
        downloadBtn.style.display = 'none';
        finalPdfBlob = null;  // Reset before conversion

        const { PDFDocument } = PDFLib;
        const pdfDoc = await PDFDocument.create();

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const imgDataUrl = await fileToDataURL(file);
            const img = await loadImage(imgDataUrl);
            const blob = await resizeAndCompress(img);
            const arrayBuffer = await blob.arrayBuffer();
            const pdfImage = await pdfDoc.embedJpg(arrayBuffer);
            const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
            page.drawImage(pdfImage, {
                x: 0,
                y: 0,
                width: pdfImage.width,
                height: pdfImage.height
            });
            progress.style.width = `${((i + 1) / files.length) * 100}%`;
        }

        const pdfBytes = await pdfDoc.save();
        finalPdfBlob = new Blob([pdfBytes], { type: 'application/pdf' }); // Save PDF blob

        downloadBtn.style.display = 'inline-block';
        convertBtn.disabled = false;
        convertBtn.textContent = 'Convert to PDF';
    });

    downloadBtn.addEventListener('click', () => {
        if (finalPdfBlob) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(finalPdfBlob);
            link.download = 'images-to-pdf.pdf';
            link.click();
        } else {
            alert('No PDF available to download. Please convert first.');
        }
    });

    function fileToDataURL(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    }

    function loadImage(src) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.src = src;
        });
    }

    function resizeAndCompress(image, maxWidth = 800, maxHeight = 800) {
        return new Promise((resolve) => {
            let { width, height } = image;
            const scale = Math.min(maxWidth / width, maxHeight / height, 1);
            width *= scale;
            height *= scale;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d').drawImage(image, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.85);
        });
    }
</script>